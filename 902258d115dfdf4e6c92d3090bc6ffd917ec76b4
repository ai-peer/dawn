{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ad75f559_99c27773",
        "filename": "src/dawn/native/vulkan/DeviceVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 264,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2022-07-25T13:25:17Z",
      "side": 1,
      "message": "[1]",
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8cc11c15_35e939fd",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-25T12:30:01Z",
      "side": 1,
      "message": "The problem here is that we are unable to ensure that there will a SubmitPendingCommands() afterward, which is right before the \u0027exportSemaphore\u0027 is used by clients.\n\nThe current implementation of WebGPU Canvas basically is like:\n  a) Chromium WebGPU: Disassociate a external texture(Canvas).\n  b) Chromium SI: runs \u0027ExportVulkanImage\u0027\n  c) Dawn: returns here with \u0027exportSemaphore\u0027.\n  d) Chromium Viz: Begin GL access to the texture whose \u0027exportSemaphore\u0027 may not be submitted yet.",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9b557218_14dbec17",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-25T13:05:04Z",
      "side": 1,
      "message": "Another constraint is that vkspec requires that we can export a VkSemaphore only after it has been submitted.\n\nhttps://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#VUID-VkSemaphoreGetFdInfoKHR-handleType-01135\n\nVUID-VkSemaphoreGetFdInfoKHR-handleType-01135\nIf handleType refers to a handle type with copy payload transference semantics, semaphore must be signaled, or have an associated semaphore signal operation pending execution",
      "parentUuid": "8cc11c15_35e939fd",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "21303eb7_8d48aa49",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2022-07-25T13:08:05Z",
      "side": 1,
      "message": "Re: first comment: the point is that the export semaphores are created during the VkQueueSubmit that use this resource, so there is no need to make a submit afterwards.\n\nRe: second comment: in that case we could do an empty submit, or better, re-export (or never import) the FD used to import this resource into Dawn.",
      "parentUuid": "9b557218_14dbec17",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7402968f_20695bba",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-25T13:22:49Z",
      "side": 1,
      "message": "\u003e Re: first comment: the point is that the export semaphores are created during the VkQueueSubmit that use this resource, so there is no need to make a submit afterwards.\n\nIIUC, the resource can be used by viz GL drivers also, where there is no VkQueueSubmit. I\u0027m kind of confused. Did you mean the export semaphores here, at runtime, must have been submitted? How is it ensured in this CL?",
      "parentUuid": "21303eb7_8d48aa49",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a340b715_b5bf80ed",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2022-07-25T13:25:17Z",
      "side": 1,
      "message": "The export semaphore is created and signaled at [1]",
      "parentUuid": "7402968f_20695bba",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c0ef2303_55113e9d",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-25T13:36:10Z",
      "side": 1,
      "message": "Could that be to earlier?\nFor example:\n  a) ImportExternalTexture\n  b) Use the texture\n  c) tweak the transition, submit and export the semaphore\n  d) Use the same texture and do something else and submit\n  e) ExportExternalTexture.\nSo clients expect the semaphore after the second use rather than the first use. In this case they get the wrong export semaphore.",
      "parentUuid": "a340b715_b5bf80ed",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2b8cd787_617a9e3f",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2022-07-25T13:39:30Z",
      "side": 1,
      "message": "If you do two submits:\n\n - ImportExternalTexture, import the FD semaphore\n - First submit\n   - Tweak the transition to import from foreign queue.\n   - Use the texture\n   - Create an exportable semaphore store it in the texture, record and export to foreign queue\n - Second submit\n   - Tweak the transition to import from foreign queue (discarding the previously store exportable semaphore)\n   - Use the texture\n   - Create an exportable semaphore store it in the texture, record and export to foreign queue\n - ExportExternalTexture.",
      "parentUuid": "c0ef2303_55113e9d",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7d9a5cdf_b3658c68",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-25T13:53:18Z",
      "side": 1,
      "message": "Got you, thanks!\nThere could be unnecessary foreign queue \"to/from\" between submits. I am not sure how much it impacts performance. I\u0027d have a try if you prefer that way.\n@Austin, how do yo like it?",
      "parentUuid": "2b8cd787_617a9e3f",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d27c079b_6ff5773d",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2022-07-25T19:38:56Z",
      "side": 1,
      "message": "I think this idea sounds good and is simpler to use than Resolve. We can try it, and as you said, see how it impacts performance since we will have some extra transitions if you use the shared image more than once in separate submits.",
      "parentUuid": "7d9a5cdf_b3658c68",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e85fc58f_bb74a95b",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-26T05:00:13Z",
      "side": 1,
      "message": "Okay, let me have a try, thanks!",
      "parentUuid": "d27c079b_6ff5773d",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ac8ac142_5092745e",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000028
      },
      "writtenOn": "2022-07-27T07:52:30Z",
      "side": 1,
      "message": "```\n// Exports external memory from a Vulkan image. This must be called on wrapped textures\n// before they are destroyed. It writes the semaphore to wait on and the old/new image\n// layouts to |info|. Pass VK_IMAGE_LAYOUT_UNDEFINED as |desiredLayout| if you don\u0027t want to\n// perform a layout transition.\nDAWN_NATIVE_EXPORT bool ExportVulkanImage(WGPUTexture texture,\n                                          VkImageLayout desiredLayout,\n                                          ExternalImageExportInfoVk* info);\n```\n\nWe still need to change this API for eager transition. `VkImageLayout desiredLayout,` is unknown for eager transition until ExportVulkanImage is called. Can we just remove it? It\u0027s not actually used in chromium now with only `VK_IMAGE_LAYOUT_UNDEFINED` specified.\n```\n  // Grab the signal semaphore from dawn\n  dawn::native::vulkan::ExternalImageExportInfoOpaqueFD export_info;\n  if (!dawn::native::vulkan::ExportVulkanImage(\n          texture_, VK_IMAGE_LAYOUT_UNDEFINED, \u0026export_info)) {\n    DLOG(ERROR) \u003c\u003c \"Failed to export Dawn Vulkan image.\";\n  } else {\n```",
      "parentUuid": "e85fc58f_bb74a95b",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2aaa4ceb_7faff220",
        "filename": "src/dawn/native/vulkan/TextureVk.cpp",
        "patchSetId": 1
      },
      "lineNbr": 829,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2022-07-28T00:56:25Z",
      "side": 1,
      "message": "Hm, if we\u0027re not using it then I guess it can be removed for now. In the future, I think it will be important to bring back this layout transition - though it could live somewhere else. perhaps something like:\n\n```\nwgpuQueueSubmitAndEndAccess(\n  WGPUQueue queue,\n  uint32_t commandCount,\n  WGPUCommandBuffer const * commands,\n  WGPUSharedTextureEndAccessDescriptor const* sharedTexturesToEndAccess)\n```\n\nThat would let us bundle a queue submit with the layout transitions and semaphores. Not super important right now, but if we want Dawn to be used in more places in Chrome, bundling them like this will help save on submits.\nI was told that Skia found significant performance wins from doing the transition to VK_IMAGE_LAYOUT_PRESENT_SRC_KHR in the same submit that finished rendering.\n\nAlternatively, we could pass `desiredLayout` into WrapVulkanImage on ExternalImageDescriptorVk. But, it would be an imperfect solution since the layout Chrome passes would have to be a guess of what the next layout will be (or VK_IMAGE_LAYOUT_UNDEFINED if Chrome doesn\u0027t know).\nDownside of this is that if Chrome passes VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL (ex. assuming that the WebGPU canvas will be sampled for compositing after we finish rendering to it), then if there are multiple VkQueueSubmits from Dawn, we\u0027ll be doing both unnecessary transitions to/from the foreign queue as well as extra layout transitions which could have additional cost.",
      "parentUuid": "ac8ac142_5092745e",
      "range": {
        "startLine": 825,
        "startChar": 1,
        "endLine": 829,
        "endChar": 14
      },
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3a90d9e1_86b9df39",
        "filename": "src/dawn/native/vulkan/TextureVk.h",
        "patchSetId": 1
      },
      "lineNbr": 170,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2022-07-25T10:11:59Z",
      "side": 1,
      "message": "Of course this would require a new class that wraps imported/exported VkSemaphores instead of the service acting directly on VkSemaphore / ExternalSemaphoreHandle.",
      "revId": "902258d115dfdf4e6c92d3090bc6ffd917ec76b4",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd"
    }
  ]
}