{
  "comments": [
    {
      "key": {
        "uuid": "a417bf07_e97745dd",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-14T01:38:32Z",
      "side": 1,
      "message": "BuddyResourceHeapAllocator allocator(128, 128, client);\n\nallocator.Allocate(64, 4, 0);\nallocator.Allocate(64, 4, 3);\n\nWon\u0027t these allocate in the same heapAllocation created at [1] even though they have different memory flags?",
      "range": {
        "startLine": 40,
        "startChar": 12,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4808b963_fcd1ee7b",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-16T16:27:15Z",
      "side": 1,
      "message": "The device will guarantee the allocation has matching (or compatible) memory/heap flags. Does that address your concern?",
      "parentUuid": "a417bf07_e97745dd",
      "range": {
        "startLine": 40,
        "startChar": 12,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c0a0f576_5c6caade",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-16T18:13:55Z",
      "side": 1,
      "message": "I figured this was the case. It looks like we don\u0027t store enough bits to track and ASSERT this is true, so I think we should add a comment here or in the header that the Device must guarantee this.",
      "parentUuid": "4808b963_fcd1ee7b",
      "range": {
        "startLine": 40,
        "startChar": 12,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fe33c23b_7efb47ee",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-17T01:41:31Z",
      "side": 1,
      "message": "As mentioned in previous CLs, why isn\u0027t the memoryType stored in the client itself to prevent this type of mistake? Having a double indirection from this to mClient to some HeapServiceAndResidencyManagement doesn\u0027t seem too bad.",
      "parentUuid": "c0a0f576_5c6caade",
      "range": {
        "startLine": 40,
        "startChar": 12,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1ab50f87_0093ad51",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "If referring to memoryFlags (not memoryType) -  \n\nFlags are determined at allocation-time but could be cached in Buffer/Texture in a later CL.\n\nCurrently, only NONE is used.\n\nWe could cache heapFlags in the Heap objects in the next CL. However, it\u0027s not required for placed resource(s) + heap. CreateResource will fail when flags are not compatible.",
      "parentUuid": "fe33c23b_7efb47ee",
      "range": {
        "startLine": 40,
        "startChar": 12,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ed310968_1260a84d",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 58,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-14T01:38:32Z",
      "side": 1,
      "message": "[1]",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "249ce0ee_cbdd52c4",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 58,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "ed310968_1260a84d",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "25be2a84_af221554",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 74,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-14T01:38:32Z",
      "side": 1,
      "message": "nit: Usually we pass mutable objects by pointer. Although, in this function, it looks like it can be const\u0026 ?",
      "range": {
        "startLine": 74,
        "startChar": 48,
        "endLine": 74,
        "endChar": 84
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e9eeb0da_ffdcbb6e",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.cpp",
        "patchSetId": 5
      },
      "lineNbr": 74,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "25be2a84_af221554",
      "range": {
        "startLine": 74,
        "startChar": 48,
        "endLine": 74,
        "endChar": 84
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c9fb6053_13a93dd6",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.h",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-14T01:38:32Z",
      "side": 1,
      "message": "nit: in",
      "range": {
        "startLine": 36,
        "startChar": 7,
        "endLine": 36,
        "endChar": 11
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "09ccc96c_d3f5d166",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.h",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c9fb6053_13a93dd6",
      "range": {
        "startLine": 36,
        "startChar": 7,
        "endLine": 36,
        "endChar": 11
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "10733842_b9b0c737",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.h",
        "patchSetId": 5
      },
      "lineNbr": 42,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-17T01:41:31Z",
      "side": 1,
      "message": "Can we have a comment here saying that the ownership of mClient is transferred? Even better the constructor could take a unique_ptr.",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c829c48c_f659b0f8",
        "filename": "src/dawn_native/BuddyResourceHeapAllocator.h",
        "patchSetId": 5
      },
      "lineNbr": 42,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "10733842_b9b0c737",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "905b7025_deefe069",
        "filename": "src/dawn_native/Resource.h",
        "patchSetId": 5
      },
      "lineNbr": 22,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-13T20:21:36Z",
      "side": 1,
      "message": "I\u0027m still not 100% sure why we need this in the frontend: the BuddyResourceAllocator doesn\u0027t set the mResource member of ResourceMemoryAllocation. And nothing in the frontend calls GetResource. The design you did with the BuddyAllocator as a helper class is great as it allows using it as a utility in the backends such that the frontend never needs to know about the allocation shenanigans we are doing.\n\nOr do you plan to use ResourceBase and HeapBase in the frontend at some point?\n\nSorry to keep asking questions and restructurations like this. Landing the design little by little helps with review but we lost the big picture since we diverged from the design docs.",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "81bcc3e6_dcd4eb43",
        "filename": "src/dawn_native/Resource.h",
        "patchSetId": 5
      },
      "lineNbr": 22,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-16T16:27:15Z",
      "side": 1,
      "message": "I did plan to use ResourceMemoryAllocation::mResourceBase in the front-end. See the other comment.",
      "parentUuid": "905b7025_deefe069",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "00e09b3f_64ca5b9d",
        "filename": "src/dawn_native/Resource.h",
        "patchSetId": 5
      },
      "lineNbr": 22,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "81bcc3e6_dcd4eb43",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6d3ee8c3_3364cec9",
        "filename": "src/dawn_native/ResourceMemoryAllocation.cpp",
        "patchSetId": 5
      },
      "lineNbr": 26,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-14T01:38:32Z",
      "side": 1,
      "message": "nit: const\u0026",
      "range": {
        "startLine": 26,
        "startChar": 55,
        "endLine": 26,
        "endChar": 70
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2253e860_e9eba32e",
        "filename": "src/dawn_native/ResourceMemoryAllocation.cpp",
        "patchSetId": 5
      },
      "lineNbr": 26,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6d3ee8c3_3364cec9",
      "range": {
        "startLine": 26,
        "startChar": 55,
        "endLine": 26,
        "endChar": 70
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f896de2f_732b4ade",
        "filename": "src/dawn_native/ResourceMemoryAllocation.h",
        "patchSetId": 5
      },
      "lineNbr": 65,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-13T20:21:36Z",
      "side": 1,
      "message": "Please describe what the difference is between this mOffset and the mBlockOffset",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9b8b848f_90fa549a",
        "filename": "src/dawn_native/ResourceMemoryAllocation.h",
        "patchSetId": 5
      },
      "lineNbr": 65,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f896de2f_732b4ade",
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4f38e98d_475292df",
        "filename": "src/dawn_native/ResourceMemoryAllocator.h",
        "patchSetId": 5
      },
      "lineNbr": 23,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-13T20:21:36Z",
      "side": 1,
      "message": "HeapAllocator now that it deals with Heaps ?",
      "range": {
        "startLine": 23,
        "startChar": 10,
        "endLine": 23,
        "endChar": 33
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ff4b1e4d_fd9d6919",
        "filename": "src/dawn_native/ResourceMemoryAllocator.h",
        "patchSetId": 5
      },
      "lineNbr": 23,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Ack.",
      "parentUuid": "4f38e98d_475292df",
      "range": {
        "startLine": 23,
        "startChar": 10,
        "endLine": 23,
        "endChar": 33
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6819d774_50c57e18",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-13T20:21:36Z",
      "side": 1,
      "message": "Wouldn\u0027t this corrspond to HeapBase instead? It encapsulates a VkMemory which is exactly like an ID3D12Heap",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "767870ea_2c190bb2",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2019-09-14T01:38:32Z",
      "side": 1,
      "message": "+1\n\nI think the separation between Resource and Heap is messy right now because the backend doesn\u0027t handle actual suballocation yet. This class really should be a Heap even though we use it as if it\u0027s a Resource everywhere else. I think the distinction will clear up in later patches.",
      "parentUuid": "6819d774_50c57e18",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b4ded47e_3594f693",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-16T16:27:15Z",
      "side": 1,
      "message": "It needs to have the same memory type used by ResourceMemoryAllocation. \n\nIf we used HeapBase, the resource allocation would be unusable by the D3D API. For Vulkan, it wouldn\u0027t matter.\n\nVkDeviceMemory is not the same as ID3D12Heap. VkDeviceMemory can represent virtual and physical addresses. ID3D12Heap represents only physical (but not virtual) addresses. I think D3D12\u0027s equivalent of vkDeviceMemory is more ID3D12Pagable.\n\nWe could either: 1) move BuddyResourceHeapAllocator to the D3D12 back-end (requires separate Resource and Heap types) OR rather than combine them, we 2) keep the BuddyResourceHeapAllocator in the front-end by adding a Vulkan-like \"device memory\" type which both ResourceBase and HeapBase inherit from (ie. MemoryBase).\n\nI\u0027m in favor of the latter. WDYT?",
      "parentUuid": "6819d774_50c57e18",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5017782a_097870b4",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-17T01:41:31Z",
      "side": 1,
      "message": "I don\u0027t understand your comment, why would this make the allocation unusable for D3D12? I\u0027m suggesting wrapping VkDeviceMemory handles in HeapBase like we wrap ID3D12Heaps.\n\nVkDeviceMemory is an allocation of physical pages just like D3D12. VkBuffer or VkTexture are the allocations of virtual memory. You can see this in the fact that you can create sparse VkBuffer/VkTexture but not VkDeviceMemory.",
      "parentUuid": "b4ded47e_3594f693",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5ee20997_481b59e4",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-18T01:14:13Z",
      "side": 1,
      "message": "ResourceMemoryAllocation expects a ResourceBase and if we use HeapBase instead (assuming HeapBase contains ID3D12Heap), then [Committed|Placed]ResourceAllocator returns a ResourceMemoryAllocation with the wrong back-end memory type on D3D. :(\n\nSince BuddyResourceHeapAllocator could work either by 1) offset into CommittedResource/VKDeviceMemory OR 2) PlacedResource + Heap. \n\nI think we\u0027ll benefit from a new MemoryBase type.\n\nMemoryBase could either contain a committed resource or heap (for D3D12) and a vkDeviceMemory (for Vulkan). Then we have ResourceMemoryAllocation[Vk|D3D] which uses the memory type expected by their API - Vk uses vkDeviceMemory and D3D uses ID3D12Resource.\n\nWDYT?",
      "parentUuid": "5017782a_097870b4",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d63bff08_e33d1938",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000262
      },
      "writtenOn": "2019-09-18T02:02:57Z",
      "side": 1,
      "message": "One confusing aspect for me is that the classes that are supposed to be generic across all backends have names like \"heap\" which is a specific D3D datatype. Even in the D3D backend, a \u0027heap\u0027 can be implemented as a committed resource with one allocation, which is even more confusing.\n\nTo me, seems like we should have two class hierarchies. MemoryBlocks and Allocations. MemoryBlocks contain one or more allocations within a memory block. If you have better name than \"memory block\" feel free to suggest. \n\nIn the D3D backend, there are two subclasses of MemoryBlocks: HeapMemoryBlocks and CommittedResourceMemoryBlocks. A HeapMemoryBlock contains a pointer to an ID3D12Heap.  A CommittedResourceMemoryBlock contains a pointer to a ID3D12Resource, which is created as a committed resource. There would only be one kind of Allocation, a ResourceAllocation which contains a pointer to a D3D12Resource. The resource can either be a placed resource or a pointer to the same committed resource in the CommittedResourceMemoryBlock.  \n\nIn the Vulkan backend, the one subclass of MemoryBlock is DeviceMemoryBlock, which contains a VkDeviceMemory handle. On the allocation side, there would simply be DeviceMemoryAllocation which just contains an offset into the VkDeviceMemory owned by the DeviceMemoryBlock class.  \n\nThoughts?",
      "parentUuid": "5ee20997_481b59e4",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5078cf31_e0b009f1",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-19T03:11:29Z",
      "side": 1,
      "message": "Hold on, this is much more complicated than it needs to be no?\n\nA HeapBase is something that is suballocated from, either ID3D12Heap or VkDeviceMemory. The ResourceMemoryAllocator should be renamed to HeapAllocator and hand out HeapBase objects to the BuddyResourceAllocator.\n\nThe BuddyResourceAllocator returns a ResourceMemoryAllocation which is the combination of a HeapBase, an offset in that HeapBase and whatever metadata the BuddyResourceAllocator needs to track state. Basically the following:\n\n struct ResourceMemoryAllocation {\n   HeapBase* heap;\n   uint64_t offsetInHeap;\n   BuddyResourceAllocatorMetadata metadata; // (contains the offset in the large buddy system)\n }\n\nThe backends call BuddyResourceAllocator, create a backend specific resource using the HeapBase and offset, then store it in backend::Buffer / backend::Texture. The frontend never gets to see ID3D12Resource or VkImage / VkBuffer and ResourceBase is removed.",
      "parentUuid": "d63bff08_e33d1938",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "aea6d1ca_fa5fb0df",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-20T17:01:24Z",
      "side": 1,
      "message": "@CW\n\n1. How does backend::[Buffer|Texture] get at the ID3D12Resource when BuddyResourceAllocator returns a ResourceMemoryAllocation that\u0027s only backed by a ID3D12Heap?\n\n2. Likewise, what does CommittedResourceAllocator now return? A heap?!?\n\nSo far, we either call Resource a Heap (confusing), merge them together (still confusing), or separate memory/allocation per backend (more complicated).\n\nThe latter approach seems reasonable to me.",
      "parentUuid": "5078cf31_e0b009f1",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "50c0e822_d17e73bb",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-20T17:18:37Z",
      "side": 1,
      "message": "1) Buffer / Texture creates its resource internally using the memory allocation (or the Device does, but not the memory allocator). The allocator doesn\u0027t need to know about the ID3D12Resource objects because their job is to hand out memory blocks, not fully created resources.\n\n2) I thought on the review for CommittedResourceAllocator we discussed it would be better to just create a heap and createPlacedResource on it so all the code paths are unified for now. So either we change it to do that, or we change CommittedResourceAllocator to return both an ID3D12Resource and a ResourceMemoryAllocation.\n\n2 again) what could happen is the following, Buffer when initialized calls Device::CreateResource (very pseudo-codish)\n\n  using D3D12ResourceAllocation \u003d std::pair\u003cResourceMemoryAllocation, ComPtr\u003cID3D12Resource\u003e;\n\n  ResultOrError\u003cD3D12ResourceAllocation\u003e Device::CreateResource(const RESOURCE_DESCRIPTOR* desc) {\n    // Of course there would be more error handling\n    if (ResourceWouldBeBig(desc)) {\n      resource \u003d CreateCommittedResource\n      return {InvalidAllocation, resource};\n    } else {\n      allocation \u003d mBuddyAllocator.allocate(descriptor.size);\n      resource \u003d CreatePlacedResource\n      return {allocation, resource}\n    }\n}",
      "parentUuid": "aea6d1ca_fa5fb0df",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "19bc57c1_c9cf9b43",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000268
      },
      "writtenOn": "2019-09-23T18:28:52Z",
      "side": 1,
      "message": "Thanks for clarifying. Looks very similar to the other suggestions. I do plan on (2).\n\nI\u0027ve revised the CL with separate allocation types and replaced ResourceHeap with MemoryBase to be consistent.",
      "parentUuid": "50c0e822_d17e73bb",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ae3d68ac_73cf083e",
        "filename": "src/dawn_native/vulkan/ResourceMemoryVk.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2019-09-23T22:08:34Z",
      "side": 1,
      "message": "Patchset 7 still is still confusing where ResourceMemoryAllocation in D3D12 contains an ID3D12Resource while in Vulkan it contains a VkDeviceMemory. These are not the same concepts in their respective APIs.\n\nThe end state we want is the \"2 again)\" above. In that end state, there is only the frontend ResourceMemoryAllocation, MemoryBase and its backend classes (imho Memory is a bit generic because it could also be CPU memory to malloc into, but we can deal with that later), and there is no need to have backend classes for ResourceMemoryAllocation since it\u0027s just a pair. (a backend allocation has-a frontend allocation info, but not is-a frontend allocation info, it will help save some awkwardness when implementing buddy allocation in the backends).",
      "parentUuid": "19bc57c1_c9cf9b43",
      "range": {
        "startLine": 24,
        "startChar": 10,
        "endLine": 24,
        "endChar": 24
      },
      "revId": "abc76d4031c30e05fe128184c5a6415eca95a052",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    }
  ]
}