{
  "comments": [
    {
      "key": {
        "uuid": "2acf7beb_92c28711",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000248
      },
      "writtenOn": "2020-05-27T19:06:51Z",
      "side": 1,
      "message": "This is just an arbitrary value that seems large enough to get the job done. Another idea is just looping on RemoveSingleEntryFromLRU and calling MakeResident until the LRU is emptied.",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "78c40221_f42bb6c6",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2020-05-27T19:17:11Z",
      "side": 1,
      "message": "Is this sure to guarantee MakeResident succeeds the second time? Maybe we should catch the failure the second time and just let it thrash.",
      "parentUuid": "2acf7beb_92c28711",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1b3d6b04_65e66a42",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000248
      },
      "writtenOn": "2020-05-27T21:33:02Z",
      "side": 1,
      "message": "It\u0027s not a guarantee, however if the previous Evict call didn\u0027t evict enough (due to fragmentation or driver oddities) - I was just thinking that 100MB would be enough to overcome the discrepancy in most scenarios.\n\n\u003e\u003e just let it thrash.\n\nWe should always to call MakeResident if we know something will be used. It is invalid to use any resource on the GPU that is not currently resident and may cause a device loss later. Given  this - I\u0027m thinking I should revise this CL.",
      "parentUuid": "78c40221_f42bb6c6",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b8cc3fd7_34992c7c",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2020-05-28T08:48:51Z",
      "side": 1,
      "message": "IMHO if we hit this then something bad is happening and we should evict everything we can so kAdditionalSizeToEvict could be 1 \u003c\u003c 63. WDYT?",
      "parentUuid": "1b3d6b04_65e66a42",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cbc81c51_148df0a1",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000248
      },
      "writtenOn": "2020-05-28T16:42:35Z",
      "side": 1,
      "message": "I like that solution a lot. I was trying to come up with something more incremental, but it is awkward since a MakeResident failure doesn\u0027t tell which memory segment needs cleaned out. Just evicting everything immediately is simple and to-the-point. \n\nRafael - WDYT?",
      "parentUuid": "b8cc3fd7_34992c7c",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8cec9443_e8eab967",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000262
      },
      "writtenOn": "2020-05-28T16:59:08Z",
      "side": 1,
      "message": "I am not in favor of evicting everything when MakeResident fails.\n\nBrandon has run into cases where true sizes of resources such as descriptor heaps cannot be calculated on the application side. The driver is free to make resources bigger if it pleases. I\u0027ve been advised by the D3D team that we should evict until we\u0027re below budget and, if MakeResident still fails, \"evict a little more\".  \n\nUp to us to decide what \"a little more\" is. We can have a hardcoded number or we could simply evict more resources until MakeResident starts to succeed again.",
      "parentUuid": "cbc81c51_148df0a1",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "359f3b95_72e92c6d",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000248
      },
      "writtenOn": "2020-05-28T17:47:45Z",
      "side": 1,
      "message": "Evicting just a little is what is recommended on the MSDN page - but I like the evicting everything approach because it doesn\u0027t guess at what the increment needs to be. We know there\u0027s a non-trivial cost to calling MakeResident, so by looping on Evict/MakeResident until it succeeds, I worry we could end up with worse performance than the scorch-the-earth approach if our increment is too small.\n\nJust for some numbers - the situation where we found a large discrepancy in tracked vs. real size estimates was for sampler descriptor heaps on my Nvidia 1070. The estimate using the recommended method was 64k vs the actual size 131k. Any other object types I\u0027ve looked at have been pretty spot on.\n\nSince our estimate vs. actual isn\u0027t too far off, I think just picking an arbitrary size is okay for most situations, but I can\u0027t be certain it\u0027s best for all situations.\n\nWDYT the size should be? I chose 100MB initially, but it seems a little big now. Maybe 50MB? Alternatively, we could evict something like 5 resources.",
      "parentUuid": "8cec9443_e8eab967",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d2658805_e8ede494",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000032
      },
      "writtenOn": "2020-05-28T17:53:32Z",
      "side": 1,
      "message": "Maybe we could evict some fixed amount, try to MakeResident, and repeat on failure until empty?",
      "parentUuid": "359f3b95_72e92c6d",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5c9d158c_bb863bb0",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000248
      },
      "writtenOn": "2020-05-28T19:20:11Z",
      "side": 1,
      "message": "I\u0027ve updated the CL to Evict 50MB then MakeResident, then loop until it succeeds or the LRUs are empty.",
      "parentUuid": "d2658805_e8ede494",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "41336e7e_443f26ae",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000262
      },
      "writtenOn": "2020-05-28T22:54:41Z",
      "side": 1,
      "message": "I\u0027m OK with 50MB as a starter number.",
      "parentUuid": "5c9d158c_bb863bb0",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "84791a20_eed0526d",
        "filename": "src/dawn_native/d3d12/ResidencyManagerD3D12.cpp",
        "patchSetId": 1
      },
      "lineNbr": 295,
      "author": {
        "id": 1000248
      },
      "writtenOn": "2020-05-29T17:52:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "41336e7e_443f26ae",
      "revId": "d3549b616f136b8e2bee3dde16b973a984d3df0d",
      "serverId": "dd02978d-1a8e-36d7-bcc0-a5723e5c0abd",
      "unresolved": false
    }
  ]
}