{{- range $subdir := $.Subdirectories }}
include({{$subdir.Path}}/BUILD.cmake)
{{- end }}

{{- Eval "TargetIfNotEmpty" ($.Project.Target $ "lib")}}
{{- Eval "TargetIfNotEmpty" ($.Project.Target $ "cmd")}}
{{- Eval "TargetIfNotEmpty" ($.Project.Target $ "test")}}


{{- /*
--------------------------------------------------------------------------------
-- Emits a CMake target if it contains any files
--------------------------------------------------------------------------------
*/ -}}
{{- define "TargetIfNotEmpty"}}
{{-   if len $.Files}}{{Eval "Target" $}}{{end}}
{{- end}}


{{- /*
--------------------------------------------------------------------------------
-- Emits a CMake target
--------------------------------------------------------------------------------
*/ -}}
{{- define "Target"}}

{{  $name := Eval "TargetPath" $}}
{{-      if eq $.Kind "lib"  }}add_library({{$name}} STATIC
{{- else if eq $.Kind "test" }}add_library({{$name}} STATIC
{{- else if eq $.Kind "cmd"  }}add_executable({{$name}}
{{- end                      }}
{{- range $File := $.Files}}
{{-   if not $File.Condition}}
  {{TrimPrefix (TrimPrefix $File.Name $.Directory.Path) "/"}}
{{-   end}}
{{- end}}
)

{{- range $File := $.Files}}
{{-   if $File.Condition}}
if ({{$File.Condition}})
  target_sources({{$name}}
    $File.Name
  )
endif()
{{-   end}}
{{- end}}

target_link_libraries({{$name}}
{{- range $Dep := $.Dependencies}}
  {{Eval "TargetPath" $Dep}}
{{- end}}
)

{{- end}}


{{- /*
--------------------------------------------------------------------------------
-- Emits the CMake library name of a target
--------------------------------------------------------------------------------
*/ -}}
{{- define "TargetPath"}}
{{- $name := Replace (print $.Name) "/" "_"}}
{{-   if eq $.Kind "lib"  }}lib_{{end}}
{{-   if eq $name  "tint" }}tint
{{-   else                }}tint_{{$name}}
{{-   end}}
{{- end}}

